<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <title>AR Viewer (Marker)</title>
  <style>
    body,
    html {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }

    video,
    canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>

  <!-- カメラ映像 -->
  <video id="camera" autoplay playsinline></video>

  <!-- AR描画用 -->
  <canvas id="arLayer"></canvas>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>

  <!-- palanAR -->
  <script src="https://cdn.jsdelivr.net/npm/palanar/dist/palanar.min.js"></script>

  <script>
    // ===== Firebase設定 =====
    const firebaseConfig = {
      apiKey: "AIzaSy***", // 自分の値に置き換えてください
      authDomain: "talk-sign.firebaseapp.com",
      databaseURL: "https://kadaikenkyu-f09eb-default-rtdb.firebaseio.com/",
      projectId: "talk-sign",
      storageBucket: "talk-sign.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdefg123456"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ===== カメラ映像取得 =====
    const video = document.getElementById("camera");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false })
      .then(stream => video.srcObject = stream)
      .catch(err => console.error("カメラ取得エラー:", err));

    // ===== palanAR 初期化 =====
    const canvas = document.getElementById("arLayer");
    const ar = new PalanAR(canvas);

    // アイコン画像
    const circleImg = new Image();
    circleImg.src = "circle.png"; // 丸アイコン
    const crossImg = new Image();
    crossImg.src = "cross.png";  // ばつアイコン

    let currentStatus = "ok"; // デフォルト状態

    // Firebaseから状態取得
    db.ref('talkStatus').on('value', snapshot => {
      currentStatus = snapshot.val(); // "ok" or "ng"
    });

    // ===== マーカー画像読み込み =====
    const markerImg = new Image();
    markerImg.src = "marker.png"; // 認識用マーカー画像

    ar.addMarker(markerImg, {
      onDetected: function (marker) {
        // マーカーを認識したときに丸／ばつを表示
        if (currentStatus === "ok") {
          ar.drawImage(circleImg, marker.x, marker.y - 100, 100, 100); // マーカーの上に表示
        } else {
          ar.drawImage(crossImg, marker.x, marker.y - 100, 100, 100);
        }
      }
    });

    // ===== 描画ループ =====
    function render() {
      ar.clear();
      ar.update(); // マーカー認識と描画
      requestAnimationFrame(render);
    }

    render();
  </script>

</body>

</html>